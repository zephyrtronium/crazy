package crazy

import "math"

// Exponential adapts a Source to generate random numbers under an exponential
// distribution.
type Exponential struct {
	Source
	z    *Ziggurat
	Rate float64
}

// NewExponential creates an exponential distribution drawing from the
// specified source with given rate parameter.
func NewExponential(src Source, rate float64) Exponential {
	return Exponential{
		Source: src,
		Rate:   rate,
		z:      expoZig,
	}
}

// Next generates an exponential variate.
func (e Exponential) Next() float64 {
	x := e.z.GenNext(e.Source)
	return x / e.Rate
}

func expoPDF(x float64) float64 {
	return math.Exp(-x)
}

func expoTail(src Source) float64 {
	return expoR - math.Log(Uniform1_2{src}.Next()-1)
}

var expoZig = &Ziggurat{
	PDF:      expoPDF,
	Tail:     expoTail,
	Mirrored: false,
	K:        expoK,
	W:        expoW,
	F:        expoF,
}

const expoR = 6.89831511661564

// This time our tables are very different from math/rand/exp.go because that
// uses 256 segments for the ziggurat.

var expoK = [128]uint32{
	0xdf9688bd, 0x0, 0x9ae6fc6f, 0xc2735d80, 0xd3e7a257,
	0xdda05826, 0xe3cac9d1, 0xe80a830a, 0xeb2479ca, 0xed81024b,
	0xef5c67c8, 0xf0dbe31e, 0xf217a773, 0xf3201c17, 0xf400c2f8,
	0xf4c1eb0d, 0xf569ba0a, 0xf5fcd510, 0xf67ecf3a, 0xf6f27431,
	0xf759fb9f, 0xf7b72d89, 0xf80b7c72, 0xf858187a, 0xf89dfd95,
	0xf8ddfe43, 0xf918cbbe, 0xf94efc48, 0xf981101d, 0xf9af7552,
	0xf9da8af1, 0xfa02a370, 0xfa2806b1, 0xfa4af3aa, 0xfa6ba1b7,
	0xfa8a41b3, 0xfaa6fee9, 0xfac1ffd1, 0xfadb66bb, 0xfaf35253,
	0xfb09de1a, 0xfb1f22cb, 0xfb3336ae, 0xfb462de1, 0xfb581a98,
	0xfb690d54, 0xfb791512, 0xfb883f71, 0xfb9698da, 0xfba42c9c,
	0xfbb1050b, 0xfbbd2b94, 0xfbc8a8d2, 0xfbd384a6, 0xfbddc642,
	0xfbe77438, 0xfbf0948a, 0xfbf92cb3, 0xfc0141b1, 0xfc08d80f,
	0xfc0ff3eb, 0xfc1698ff, 0xfc1ccaa6, 0xfc228bdf, 0xfc27df57,
	0xfc2cc767, 0xfc31461c, 0xfc355d37, 0xfc390e2f, 0xfc3c5a34,
	0xfc3f4230, 0xfc41c6c7, 0xfc43e858, 0xfc45a6fb, 0xfc470282,
	0xfc47fa79, 0xfc488e1f, 0xfc48bc69, 0xfc4883fa, 0xfc47e325,
	0xfc46d7e3, 0xfc455fd0, 0xfc437824, 0xfc411dae, 0xfc3e4cc8,
	0xfc3b014f, 0xfc373696, 0xfc32e75d, 0xfc2e0dbb, 0xfc28a311,
	0xfc229ff6, 0xfc1bfc1c, 0xfc14ae35, 0xfc0cabd5, 0xfc03e94a,
	0xfbfa596d, 0xfbefed74, 0xfbe494ac, 0xfbd83c33, 0xfbcace9f,
	0xfbbc3390, 0xfbac4f30, 0xfb9b0195, 0xfb8825fe, 0xfb7391e3,
	0xfb5d13cb, 0xfb4471d5, 0xfb2967da, 0xfb0ba50d, 0xfaeac8e3,
	0xfac65f0c, 0xfa9dda0b, 0xfa708bfd, 0xfa3d9cac, 0xfa03fbab,
	0xf9c24ca1, 0xf976ca7a, 0xf91f1c56, 0xf8b8130b, 0xf83d3ed2,
	0xf7a83dea, 0xf6ef8575, 0xf6041c96, 0xf4cd07fc, 0xf31d0df9,
	0xf0986fbc, 0xec622f1f, 0xe3ae1dd0,
}

var expoW = [128]float32{
	1.83896979238271e-9, 2.12666387909333e-11, 3.51464110279624e-11,
	4.62712849325506e-11, 5.58998558492917e-11, 6.45697743808646e-11,
	7.25655507432902e-11, 8.00581622324609e-11, 8.7159450032918e-11,
	9.39471534256647e-11, 1.00477836569034e-10, 1.06794154152732e-10,
	1.12929210461413e-10, 1.18909313745999e-10, 1.24755791679591e-10,
	1.3048623066965e-10, 1.3611534730027e-10, 1.41655616837582e-10,
	1.47117736590304e-10, 1.5251097414908e-10, 1.57843433587404e-10,
	1.63122262049909e-10, 1.68353812266114e-10, 1.73543771967875e-10,
	1.78697268104555e-10, 1.83818951622921e-10, 1.88913067086111e-10,
	1.9398351034166e-10, 1.99033876678493e-10, 2.04067501348228e-10,
	2.0908749390707e-10, 2.14096767519973e-10, 2.19098064130193e-10,
	2.2409397621451e-10, 2.29086965703212e-10, 2.34079380533803e-10,
	2.39073469220945e-10, 2.44071393756744e-10, 2.49075241100989e-10,
	2.54087033477306e-10, 2.59108737655971e-10, 2.6414227337564e-10,
	2.69189521033009e-10, 2.7425232875046e-10, 2.79332518916186e-10,
	2.84431894278463e-10, 2.8955224366522e-10, 2.94695347391305e-10,
	2.99862982408714e-10, 3.05056927249101e-10, 3.10278966803067e-10,
	3.15530896976784e-10, 3.20814529263327e-10, 3.26131695263616e-10,
	3.31484251189921e-10, 3.36874082383544e-10, 3.4230310787731e-10,
	3.47773285033074e-10, 3.53286614284336e-10, 3.58845144014404e-10,
	3.64450975601217e-10, 3.70106268661071e-10, 3.75813246524943e-10,
	3.81574201983036e-10, 3.87391503335491e-10, 3.93267600790039e-10,
	3.9920503325069e-10, 4.05206435545471e-10, 4.11274546145768e-10,
	4.17412215435078e-10, 4.2362241459109e-10, 4.29908245152006e-10,
	4.36272949346094e-10, 4.42719921272811e-10, 4.49252719034544e-10,
	4.55875077930452e-10, 4.62590924838212e-10, 4.69404393926091e-10,
	4.7631984385704e-10, 4.83341876668933e-10, 4.90475358541192e-10,
	4.97725442688635e-10, 5.05097594659193e-10, 5.12597620354296e-10,
	5.2023169714044e-10, 5.28006408479314e-10, 5.35928782573765e-10,
	5.44006335610289e-10, 5.52247120278507e-10, 5.6065978036808e-10,
	5.69253612388347e-10, 5.7803863533162e-10, 5.87025669915088e-10,
	5.96226428898386e-10, 6.05653620396592e-10, 6.15321066507869e-10,
	6.25243840072496e-10, 6.35438423003376e-10, 6.45922890414461e-10,
	6.56717125772278e-10, 6.67843073573835e-10, 6.79325037702609e-10,
	6.91190035758515e-10, 7.03468222471821e-10, 7.16193399040256e-10,
	7.29403630221876e-10, 7.43141997777303e-10, 7.57457528120353e-10,
	7.72406344900286e-10, 7.88053115355215e-10, 8.04472885186895e-10,
	8.21753434400052e-10, 8.39998342416347e-10, 8.5933103530589e-10,
	8.79900218862133e-10, 9.01887309178066e-10, 9.25516812451667e-10,
	9.51071180590837e-10, 9.78912678390915e-10, 1.00951664943384e-9,
	1.04352414427853e-9, 1.08182922305131e-9, 1.12573252230064e-9,
	1.17723228149081e-9, 1.23963280886819e-9, 1.31900246862456e-9,
	1.42846089892584e-9, 1.60613914872884e-9,
}

var expoF = [128]float32{
	1.0, 0.912707777475125, 0.859888382509951,
	0.819768204987318, 0.786558599390136, 0.757808116931513,
	0.732225562307742, 0.70903726877305, 0.687738233900834,
	0.667978059185555, 0.649502221835904, 0.632119133965389,
	0.615680409581244, 0.600068409921909, 0.585188041317763,
	0.570961159629425, 0.557322637577984, 0.544217529519877,
	0.531598981894556, 0.51942666330534, 0.507665564832616,
	0.496285069354161, 0.485258219764561, 0.474561136575439,
	0.464172549299398, 0.454073415617565, 0.444246609064009,
	0.434676660760544, 0.425349544207953, 0.41625249468547,
	0.407373856699979, 0.398702954344945, 0.390229980505289,
	0.381945901669019, 0.37384237574385, 0.365911680774217,
	0.358146652844753, 0.350540631765755, 0.343087413382875,
	0.335781207551399, 0.328616600975456, 0.321588524242527,
	0.314692222489879, 0.307923229226805, 0.301277342908602,
	0.294750605918, 0.288339285659537, 0.282039857514072,
	0.275848989435651, 0.269763528002485, 0.26378048575885,
	0.257897029705952, 0.252110470817996, 0.246418254475166,
	0.240817951718609, 0.235307251243941, 0.229883952059758,
	0.22454595674618, 0.219291265255944, 0.21411796920705,
	0.209024246621641, 0.204008357070756, 0.199068637188979,
	0.194203496526831, 0.189411413712133, 0.18469093289458,
	0.180040660450423, 0.175459261926495, 0.170945459204952,
	0.166498027871972, 0.162115794775345, 0.157797635757395,
	0.153542473551082, 0.149349275828338, 0.145217053390856,
	0.141144858494566, 0.137131783300012, 0.133176958441711,
	0.129279551710424, 0.125438766843016, 0.121653842415384,
	0.117924050834575, 0.114248697426989, 0.110627119620188,
	0.107058686216575, 0.103542796757883, 0.100078880980158,
	0.0966663983596901, 0.0933048377511747, 0.0899937171202717,
	0.0867325833737408, 0.0835210122914216, 0.0803586085655968,
	0.0772450059547157, 0.0741798675601352, 0.0711628862364988,
	0.0681937851487071, 0.0652723184912142, 0.0623982723887404,
	0.0595714660015745, 0.0567917528636362, 0.0540590224876553,
	0.0513732022795311, 0.048734259813628, 0.0461422055330636,
	0.043597095954805, 0.0410990374797804, 0.0386481909348909,
	0.0362447770091108, 0.0338890827931727, 0.0315814696966008,
	0.0293223831044655, 0.0271123642604352, 0.0249520650399684,
	0.0228422665356619, 0.0207839027613827, 0.0187780913696083,
	0.0168261742012834, 0.0149297719923083, 0.0130908601063722,
	0.0113118766723302, 0.00959588294047461, 0.00794681255393166,
	0.00636988317909038, 0.00487233313651832, 0.0034648966761225,
	0.00216530760995328, 0.00100948486124341,
}
